{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'main/public.css' %}">
    <title>Ferias disponibles</title>
</head>
<body>

    <!-- Botón de login -->
    <div style="text-align:right; margin: 15px 20px;">
        <a href="{% url 'login' %}">
            <button style="padding:8px 16px; border-radius:8px; border:none; background:#00e0ff; color:#fff; font-weight:bold; cursor:pointer;">
                Iniciar Sesión
            </button>
        </a>
    </div>

    <h1 style="text-align:center; margin-bottom:20px; color:#ff00ff;">Ferias disponibles</h1>

    <!-- Coverflow -->
    <div class="coverflow-wrapper">
      <div class="coverflow-container" tabindex="0">
        <div class="coverflow" id="coverflow">
          {% for feria in ferias %}
          <div class="coverflow-item">
            <div class="cover">
              <h3>{{ feria.nombre }}</h3>
              <p><b>Cupos:</b> {{ feria.ocupados }}/{{ feria.total_cupos }}</p>
              <p><b>Fechas:</b> {{ feria.fecha_inicio }} al {{ feria.fecha_fin }}</p>
              <p><b>Preferencias:</b> {{ feria.preferencias }}</p>
              <ul>
                {% for tp in feria.tipos %}
                  <li>{{ tp.tipo }}: {{ tp.ocupados }}/{{ tp.cupos_totales }}</li>
                {% empty %}
                  <li>No hay tipos de productos definidos</li>
                {% endfor %}
              </ul>
              <span id="countdown-{{ feria.id }}">Cargando...</span>
            </div>
            <div class="reflection"></div>
          </div>
          {% empty %}
            <p style="color:#ccc;">No hay ferias disponibles</p>
          {% endfor %}
        </div>

        <!-- Botones navegación -->
        <button class="nav-button prev" onclick="navigate(-1)">‹</button>
        <button class="nav-button next" onclick="navigate(1)">›</button>

        <!-- Dots -->
        <div class="dots-container" id="dots"></div>

        <!-- Autoplay -->
        <button class="play-pause-button" onclick="toggleAutoplay()">
          <span class="play-icon">▶</span>
          <span class="pause-icon" style="display:none;">❚❚</span>
        </button>
      </div>
    </div>
    <!-- Artesanos dinámicos -->
    <h2 style="text-align:center; margin:40px 0 15px; color:#00e0ff;">Artesanos</h2>
    <ul id="artesanos-list" style="list-style:none; padding:0; max-width:800px; margin:0 auto; color:#ddd; text-align:center;">
      <li>Selecciona una feria para ver sus artesanos...</li>
    </ul>
    <!-- Buscar Artesanos -->
    <div id="buscar-artesanos" style="margin:50px auto; max-width:600px; text-align:center; background:rgba(255,255,255,0.05); padding:20px; border-radius:12px;">
        <h2 style="color:#ff00ff;">Buscar Artesanos</h2>
        <form method="get" action="#buscar-artesanos" style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
            <input type="text" id="busqueda" name="busqueda"
                  value="{{ request.GET.busqueda|default:'' }}"
                  placeholder="Ej: cerámica, tejidos..."
                  style="flex:1; padding:10px; border-radius:8px; border:1px solid #00e0ff; background:rgba(0,0,0,0.3); color:#fff;">
            <button type="submit"
                    style="padding:10px 18px; border:none; border-radius:8px; background:linear-gradient(45deg,#ff00ff,#00e0ff); color:#fff; font-weight:bold; cursor:pointer;">
                Buscar
            </button>
        </form>

        {% if busqueda %}
            <h3 style="margin-top:20px; color:#00e0ff;">
                Resultados de búsqueda para "{{ busqueda }}"
            </h3>
            <ul style="list-style:none; padding:0; margin-top:10px; color:#ddd;">
                {% for a in artesanos_filtrados %}
                    <li style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <b>{{ a.nombre }}</b> ({{ a.tipo }}) - {{ a.descripcion }} <br>
                        Feria: {{ a.feria.nombre }} <br>
                        Del {{ a.feria.fecha_inicio }} al {{ a.feria.fecha_fin }}
                    </li>
                {% empty %}
                    <li>No se encontraron artesanos.</li>
                {% endfor %}
            </ul>
        {% endif %}

    </div>
    <!-- Artesanos -->
    <h2 style="text-align:center; margin:40px 0 15px; color:#00e0ff;">Todos los Artesanos</h2>
    <ul style="list-style:none; padding:0; max-width:800px; margin:0 auto; color:#ddd;">
      {% for a in artesanos %}
        <li style="padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
          <b>{{ a.nombre }}</b> ({{ a.tipo }}) - {{ a.descripcion }}
        </li>
      {% empty %}
        <li>No hay artesanos registrados</li>
      {% endfor %}
    </ul>

<script>
  
/* Countdown por feria */
document.addEventListener("DOMContentLoaded", function () {
    {% for feria in ferias %}
    (function() {
        const startDate = new Date("{{ feria.fecha_inicio }}T00:00:00").getTime();
        const endDate = new Date("{{ feria.fecha_fin }}T23:59:59").getTime();
        const now = new Date().getTime();
        const countdownEl = document.getElementById("countdown-{{ feria.id }}");
        if (!countdownEl) return;

        let targetDate = startDate;
        let messagePrefix = "Inicia en:";
        if (now > startDate && now < endDate) { targetDate = endDate; messagePrefix = "Termina en:"; }
        if (now > endDate) { countdownEl.innerHTML = "Finalizada"; return; }

        const interval = setInterval(function() {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance <= 0) { clearInterval(interval); countdownEl.innerHTML = "En curso"; return; }

            const days = Math.floor(distance / (1000*60*60*24));
            const hours = Math.floor((distance % (1000*60*60*24)) / (1000*60*60));
            const minutes = Math.floor((distance % (1000*60*60)) / (1000*60));
            const seconds = Math.floor((distance % (1000*60)) / 1000);
            countdownEl.innerHTML = messagePrefix + " " + days+"d "+hours+"h "+minutes+"m "+seconds+"s";
        }, 1000);
    })();
    {% endfor %}
});

/* Coverflow */
const items = document.querySelectorAll('.coverflow-item');
const dotsContainer = document.getElementById('dots');
const container = document.querySelector('.coverflow-container');

// Datos de artesanos por feria desde Django
const artesanosPorFeria = JSON.parse('{{ artesanos_por_feria|safe }}');
const artesanosList = document.getElementById('artesanos-list');

// Función para mostrar artesanos de la feria activa
function mostrarArtesanos(feriaId) {
  const lista = artesanosPorFeria[feriaId] || [];
  if (lista.length === 0) {
    artesanosList.innerHTML = "<li>No hay artesanos registrados en esta feria.</li>";
    return;
  }
  artesanosList.innerHTML = lista.map(a => `
    <li style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
      <b>${a.nombre}</b> (${a.tipo}) - ${a.descripcion}
    </li>
  `).join("");
}


let currentIndex = 0;
let isAnimating = false;
let autoplayInterval = null;
let isPlaying = true;

const playIcon = document.querySelector('.play-icon');
const pauseIcon = document.querySelector('.pause-icon');

items.forEach((_, index) => {
  const dot = document.createElement('div');
  dot.className = 'dot';
  dot.onclick = () => goToIndex(index);
  dotsContainer.appendChild(dot);
});
const dots = document.querySelectorAll('.dot');

function updateCoverflow() {
  if (isAnimating) return;
  isAnimating = true;
  items.forEach((item, index) => {
    let offset = index - currentIndex;
    if (offset > items.length/2) offset -= items.length;
    else if (offset < -items.length/2) offset += items.length;
    const absOffset = Math.abs(offset), sign = Math.sign(offset);
    let translateX = offset*220, translateZ = -absOffset*200;
    let rotateY = -sign * Math.min(absOffset*60, 60);
    let opacity = 1-(absOffset*0.2), scale = 1-(absOffset*0.1);
    if (absOffset > 3) { opacity=0; translateX=sign*800; }
    item.style.transform = `translateX(${translateX}px) translateZ(${translateZ}px) rotateY(${rotateY}deg) scale(${scale})`;
    item.style.opacity = opacity; item.style.zIndex = 100-absOffset;
    item.classList.toggle('active', index===currentIndex);
    const feriaActiva = {{ ferias|safe }}[currentIndex];
    mostrarArtesanos(feriaActiva.id);

  });
  dots.forEach((dot,i)=>dot.classList.toggle('active', i===currentIndex));
  setTimeout(()=>{isAnimating=false;},600);
}

function navigate(d){ if(isAnimating)return; currentIndex+=d;
  if(currentIndex<0)currentIndex=items.length-1;
  if(currentIndex>=items.length)currentIndex=0;
  updateCoverflow(); }
function goToIndex(i){ if(isAnimating||i===currentIndex)return; currentIndex=i; updateCoverflow(); }

function startAutoplay(){ autoplayInterval=setInterval(()=>{currentIndex=(currentIndex+1)%items.length; updateCoverflow();},4000);
  isPlaying=true; playIcon.style.display='none'; pauseIcon.style.display='block'; }
function stopAutoplay(){ if(autoplayInterval){ clearInterval(autoplayInterval); autoplayInterval=null; }
  isPlaying=false; playIcon.style.display='block'; pauseIcon.style.display='none'; }
function toggleAutoplay(){ isPlaying?stopAutoplay():startAutoplay(); }

items.forEach((item,i)=>item.addEventListener('click',()=>goToIndex(i)));
container.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft')navigate(-1); if(e.key==='ArrowRight')navigate(1); });
let touchStartX=0,touchEndX=0;
container.addEventListener('touchstart',e=>{touchStartX=e.changedTouches[0].screenX;},{passive:true});
container.addEventListener('touchend',e=>{touchEndX=e.changedTouches[0].screenX; const diff=touchStartX-touchEndX;
  if(Math.abs(diff)>30){ diff>0?navigate(1):navigate(-1);} },{passive:true});

updateCoverflow(); container.focus(); startAutoplay();
</script>

</body>
</html>
